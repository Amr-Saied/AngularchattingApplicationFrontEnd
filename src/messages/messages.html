<div class="messages-container">
  <!-- Conversations List -->
  <div
    *ngIf="!showChat && !showLikedUsers && conversations.length > 0"
    class="conversations-list"
  >
    <div class="conversations-header">
      <h2>üí¨ Your Conversations</h2>
      <div class="conversations-count">{{ conversations.length }} chats</div>
    </div>

    <div class="conversations-grid">
      <div
        class="conversation-card"
        *ngFor="let conversation of conversations"
        (click)="selectConversation(conversation)"
      >
        <div class="conversation-avatar">
          <img
            [src]="getProfileImageUrl(conversation.otherUserPhotoUrl)"
            [alt]="conversation.otherUsername"
            class="avatar-image"
          />
          <div
            class="online-status"
            [class.online]="isUserOnline(conversation.otherUserId)"
            [class.offline]="!isUserOnline(conversation.otherUserId)"
          ></div>
        </div>

        <div class="conversation-content">
          <div class="conversation-header">
            <h3 class="username">{{ conversation.otherUsername }}</h3>
            <span class="message-time">{{
              formatTime(conversation.lastMessageTime)
            }}</span>
          </div>

          <div class="conversation-footer">
            <p class="last-message">
              <span class="message-icon">üí≠</span>
              {{ conversation.lastMessage }}
            </p>
            <div class="conversation-badges">
              <div class="unread-badge" *ngIf="conversation.unreadCount > 0">
                {{ conversation.unreadCount }}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- No Conversations - Show Liked Users -->
  <div *ngIf="!showChat && showLikedUsers" class="liked-users">
    <h2>Start a Conversation</h2>
    <p class="no-conversations">
      You don't have any conversations yet. Start chatting with people you
      liked!
    </p>

    <div class="liked-users-grid">
      <div
        class="user-card"
        *ngFor="let user of likedUsers"
        (click)="startChatWithUser(user)"
      >
        <img
          [src]="getProfileImageUrl(user.photoUrl)"
          [alt]="user.userName"
          class="user-photo"
        />
        <div class="user-info">
          <h3>{{ user.userName }}</h3>
          <p>{{ user.knownAs }}</p>
        </div>
        <button class="chat-button">Start Chat</button>
      </div>
    </div>

    <div *ngIf="likedUsers.length === 0" class="no-liked-users">
      <p>
        You haven't liked anyone yet. Go to the Members page to discover people!
      </p>
      <button class="primary-button" (click)="navigateToMembers()">
        Browse Members
      </button>
    </div>
  </div>

  <!-- Chat Window -->
  <div *ngIf="showChat && selectedConversation" class="chat-window">
    <div class="chat-header">
      <button class="back-button" (click)="backToConversations()">
        ‚Üê Back
      </button>
      <h2>{{ selectedConversation.otherUsername }}</h2>
    </div>

    <div class="messages-list">
      <div
        *ngFor="let message of messages"
        class="message-item"
        [ngClass]="{
          'my-message': isMyMessage(message),
          'other-message': !isMyMessage(message)
        }"
      >
        <div class="message-avatar" *ngIf="!isMyMessage(message)">
          <img
            [src]="getProfileImageUrl(message.senderPhotoUrl)"
            [alt]="message.senderUsername"
            class="message-avatar-image"
          />
        </div>

        <div class="message-content">
          <!-- Voice Message -->
          <div *ngIf="isVoiceMessage(message)" class="voice-message">
            <div class="voice-message-bubble">
              <button
                class="play-voice-btn"
                (click)="toggleVoicePlayback(message)"
                [class.playing]="isVoicePlaying(message)"
              >
                <span *ngIf="!isVoicePlaying(message)">‚ñ∂Ô∏è</span>
                <span *ngIf="isVoicePlaying(message)">‚è∏Ô∏è</span>
              </button>
              <div class="voice-waveform">
                <div class="waveform-bars">
                  <div
                    class="waveform-bar"
                    *ngFor="
                      let bar of getWaveformBars(message.voiceDuration || 0)
                    "
                  ></div>
                </div>
              </div>
              <span class="voice-duration">{{
                formatRecordingDuration(message.voiceDuration || 0)
              }}</span>
            </div>
            <p class="voice-message-text" *ngIf="message.content">
              {{ message.content }}
            </p>
          </div>

          <!-- Text Message -->
          <p *ngIf="!isVoiceMessage(message)">
            {{ message.content }}
            <span *ngIf="message.emoji" class="emoji">{{ message.emoji }}</span>
          </p>
          <div class="message-footer">
            <span class="message-time">{{
              formatTime(message.messageSent)
            }}</span>

            <!-- Read Status Indicators for My Messages -->
            <div *ngIf="isMyMessage(message)" class="message-status">
              <span
                class="read-status"
                [ngClass]="{
                  read: message.dateRead,
                  sent: !message.dateRead
                }"
                [title]="getReadStatusTitle(message)"
              >
                <span *ngIf="!message.dateRead">‚úì</span>
                <span *ngIf="message.dateRead">‚úì‚úì</span>
              </span>

              <button
                class="delete-message-btn"
                (click)="deleteMessage(message.id)"
                title="Delete message"
              >
                üóëÔ∏è
              </button>
            </div>
          </div>
        </div>

        <div class="message-avatar" *ngIf="isMyMessage(message)">
          <img
            [src]="getProfileImageUrl(message.senderPhotoUrl)"
            [alt]="message.senderUsername"
            class="message-avatar-image"
          />
        </div>
      </div>

      <!-- Typing indicator -->
      <div *ngIf="isTyping" class="typing-indicator">
        <div class="typing-dots">
          <span></span>
          <span></span>
          <span></span>
        </div>
        <span class="typing-text"
          >{{ selectedConversation.otherUsername }} is typing...</span
        >
      </div>
    </div>

    <!-- Voice Recording UI -->
    <div *ngIf="isRecording" class="voice-recording-container">
      <div class="voice-recording-indicator">
        <div class="recording-dot"></div>
        <span class="recording-text">Recording...</span>
        <span class="recording-duration">{{
          formatRecordingDuration(recordingDuration)
        }}</span>
      </div>
      <div class="voice-recording-actions">
        <button (click)="stopVoiceRecording()" class="stop-recording-btn">
          Stop & Send
        </button>
        <button (click)="cancelVoiceRecording()" class="cancel-recording-btn">
          Cancel
        </button>
      </div>
    </div>

    <div class="message-input" *ngIf="!isRecording">
      <input
        type="text"
        [(ngModel)]="newMessageContent"
        placeholder="Type your message..."
        (keyup.enter)="sendMessage()"
        (input)="onMessageInput()"
        class="message-text-input"
      />
      <div class="input-buttons">
        <button
          type="button"
          (click)="toggleEmojiPicker($event)"
          class="emoji-button"
        >
          üòä
        </button>
        <button
          type="button"
          (click)="startVoiceRecording()"
          class="voice-button"
          title="Record voice message"
        >
          üé§
        </button>
        <button (click)="sendMessage()" class="send-button">Send</button>
      </div>
    </div>

    <!-- Emoji Picker -->
    <div
      *ngIf="showEmojiPicker"
      class="emoji-picker-container"
      [ngClass]="{ show: showEmojiPicker }"
      (click)="onEmojiPickerClick($event)"
    >
      <div class="emoji-picker">
        <div class="emoji-grid">
          <button
            *ngFor="let emoji of emojis"
            type="button"
            class="emoji-btn"
            (click)="addEmoji(emoji)"
          >
            {{ emoji }}
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal-overlay" *ngIf="showDeleteModal" (click)="cancelDelete()">
  <div class="modal-content delete-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Delete Message</h3>
      <button class="modal-close" (click)="cancelDelete()">&times;</button>
    </div>
    <div class="modal-body">
      <div class="delete-warning">
        <p><strong>Are you sure you want to delete this message?</strong></p>
        <p>This action cannot be undone.</p>
      </div>
      <div class="modal-actions">
        <button
          type="button"
          class="btn btn-secondary"
          (click)="cancelDelete()"
        >
          Cancel
        </button>
        <button type="button" class="btn btn-danger" (click)="confirmDelete()">
          Delete
        </button>
      </div>
    </div>
  </div>
</div>
